<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>cash.js</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/main.css">
    <audio id="tuturu" autoplay></audio>

    <script>
      const audioPlayer = document.getElementById('tuturu')
      const audioPlay = soundName => { audioPlayer.src=`audio/${soundName}.mp3` }
      window.onload = _ => audioPlayer.play()
      window.onreadystatechange = _ => { window.audioPlayer = document.getElementById('tuturu' )}

      const socket = io()
      socket.on('title', t => document.title = t)

      const arbitrages = {}
      const renderArbitrages = _ => {
        arbitragesRenderer.querySelector('pre').innerHTML = JSON.stringify(Object.keys(arbitrages).reduce((json, time) => ({
          ...json,
          [new Date(Number(time)).toLocaleString()]: {
            ...arbitrages[time],
            resolved: arbitrages[time].resolved
              && new Date(arbitrages[time].resolved).toLocaleString()
          }
        }), {}), null, 2)
      }

      socket.on('state', state => {
        const stateRenderer = document.querySelector('#stateRenderer > pre')
        const profitRenderer = document.querySelector('#profit > pre')
        try {
          const balances = JSON.parse(stateRenderer.innerHTML).balances
          let profitsUpdate = false

          for(token in balances) {
            if (state.balances[token] != balances[token]) {
              profits[token] = profits[token] + state.balances[token] - balances[token]
              profitsUpdate = true
            }
          }
          if (profitsUpdate) {
            document.querySelector('#profits > pre')
              .innerHTML = JSON.stringify(profits, null, 2)
          }
        } catch {// First time getting state, JSON.parse threw
          // console.log('Got first state.', state)
          audioPlay('startup')
          for (token in state.balances) {
            profits[token] = 0
          }
          document.querySelector('#profits > pre')
            .innerHTML = JSON.stringify(profits, null, 2)
        }
        stateRenderer.innerHTML = JSON.stringify({
          balances: state.balances,
          market: state.market
        }, null, 2)
        profitRenderer.innerHTML = JSON.stringify(state.profits, null, 2)
      })

      socket.on('graph', graph => {
        // console.log(graph)
        const data = {// ...graph }
          path: graph.run,
          pnl: graph.pnl,
          hops: graph.orders.reduce((hops, { from, to, action, symbol, vol, quote, ret }) => ([
            ...hops,
            {
              from,
              to,
              symbol,
              action,
              vol,
              quote,
              ret
            }
          ]), []),
          input: graph.orders[0].cost,
          output: graph.output,
          profit: graph.profit,
          ratio: graph.ratio,
        }
        document.querySelector('#graphRenderer > pre')
          .innerHTML = JSON.stringify({
            ...data,
            time: new Date(data.time || new Date()).toLocaleString()
          }, null, 2)
      })

      socket.on('arbitrage', arb => {
        console.log(arb)
        if (!arbitrages[arb.time]) {
          arbitrages[arb.time] = arb
          audioPlay('tuturu')
          renderArbitrages()
        }
      })
      socket.on('arbitrages', update => {
        for (timestamp in update) {
          const time = Number(timestamp)
          if (!arbitrages[time]) {
            arbitrages[time] = update[timestamp]
            audioPlay('tuturu')
            renderArbitrages()
          }
        }
      })

      socket.on('resolved', arbitrage => {
        const { run, orders, input, output, profit, time } = arbitrage
        console.log('Arbitrage resolved', arbitrage)
        arbitrages[time] = {
          run,
          input,
          output,
          profit,
          resolved: new Date().getTime()
        }
        audioPlay('rupee-collect')
      })
    </script>
  </head>

  <body>
    <div class="renderer-wrapper">
      <div id="profits" class="renderer">
        <span>Profits since page load:</span>
        <pre>No data (yet).</pre>
      </div>
      <div id="profit" class="renderer">
        <span>Profit since bot start:</span>
        <pre>No data (yet).</pre>
      </div>
    </div>
    <div class="renderer-wrapper">
      <div id="stateRenderer" class="renderer">
        State:
        <pre>No data (yet).</pre>
      </div>
      <div id="graphRenderer" class="renderer">
        <span>Most profitable graph:</span>
        <pre>No data (yet).</pre>
      </div>
      <div id="arbitragesRenderer" class="renderer">
        <span>Arbitrages:</span>
        <pre>No data (yet).</pre>
      </div>
    </div>
  </body>
</html>
