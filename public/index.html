<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>cash.js</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/main.css">
    <audio id="tuturu" autoplay></audio>
    <script>
      const socket = io()

      const arbitrages = {}
      socket.on('arbitrages', update => {
        const elem = document.querySelector('#arbitrages > pre')
        for (timestamp in update) {
          const time = Number(timestamp)
          if (!arbitrages[time]) {
            arbitrages[time] = update[timestamp]
          document.getElementById('tuturu')
            .src = 'https://www.myinstants.com/media/sounds/tuturu_1.mp3'
          }
        }
        elem.innerHTML = JSON.stringify(Object.keys(arbitrages).reduce((json, time) => ({
          ...json,
          [new Date(Number(time)).toLocaleString()]: arbitrages[time]
        }), {}), null, 2)
      })
      socket.on('graph', graph => {
        const data = {
          path: graph.run,
          hops: graph.orders.reduce((hops, { from, to, action, symbol, vol, ret }) => ([
            ...hops,
            {
              from,
              to,
              symbol,
              action,
              vol,
              ret
            }
          ]), []),
          input: Math.round(graph.orders[0].amount * 1000000) / 1000000,
          output: graph.output,
          profit: Math.round(graph.profit * 10000) / 10000,
          ratio: Math.round(graph.ratio * 1000) / 1000
        }
        document.querySelector('#graph > pre')
          .innerHTML = JSON.stringify(data, null, 2)
      })
      socket.on('state', state => {
        document.querySelector('#state > pre')
        .innerHTML = JSON.stringify(state, null, 2)
      })
    </script>
  </head>
  <body>
    <div class="renderer-wrapper">
      <div id="state" class="renderer">
        State:
        <pre>No data (yet).</pre>
      </div>
      <div id="graph" class="renderer">
        Most profitable graph:
        <pre>No data (yet).</pre>
      </div>
      <div id="arbitrages" class="renderer">
        Arbitrages:
        <pre>No data (yet).</pre>
      </div>
    </div>
  </body>
</html>
